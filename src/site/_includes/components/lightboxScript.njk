<script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
  /* Style for content images that should have lightbox functionality */
  .content img:not(#dungeon-map img) {
    cursor: zoom-in;
    transition: all 0.3s ease;
  }
  
  /* SimpleLightbox customizations */
  .sl-overlay {
    background: rgba(0, 0, 0, 0.8);
  }
  
  .sl-wrapper .sl-close {
    color: #fff;
  }
  
  .sl-wrapper .sl-navigation button {
    color: #fff;
  }
  
  .sl-wrapper .sl-counter {
    color: #fff;
  }
</style>

<script>
  // Function to get the appropriate image source based on the picture element
  function getAppropriateImageSource(pictureElement) {
    // If there's no picture element, return null
    if (!pictureElement) return null;
    
    // First, try to find the original full-size image (usually in the img tag)
    const imgElement = pictureElement.querySelector('img');
    if (imgElement && imgElement.getAttribute('src')) {
      // This is the full-size image we want to use for the lightbox
      return imgElement.getAttribute('src');
    }
    
    return null;
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit to ensure all images are loaded
    setTimeout(function() {
      try {
        // First, add necessary attributes to images for SimpleLightbox to work
        const contentImages = document.querySelectorAll('.content img:not(#dungeon-map img)');
        
        contentImages.forEach(function(img) {
          // Skip if image is inside dungeon map
          if (img.closest('#dungeon-map')) {
            return;
          }
          
          // Check if the image is inside a picture element
          const pictureElement = img.closest('picture');
          let fullSizeImageSrc = img.src; // Default to img.src
          
          if (pictureElement) {
            // Get the full-size image source from the picture element
            const appropriateSource = getAppropriateImageSource(pictureElement);
            if (appropriateSource) {
              fullSizeImageSrc = appropriateSource;
            }
          }
          
          // Create a link around the image or picture element if it doesn't already have one
          if (img.parentNode.tagName !== 'A') {
            const link = document.createElement('a');
            link.href = fullSizeImageSrc; // Set the link to the full-size image source
            link.classList.add('lightbox-image');
            
            // If the image is inside a picture element, wrap the picture element
            if (pictureElement && pictureElement !== img.parentNode) {
              // Move the link to be the parent of the picture element
              pictureElement.parentNode.insertBefore(link, pictureElement);
              link.appendChild(pictureElement);
            } else {
              // Replace the image with the link+image
              img.parentNode.insertBefore(link, img);
              link.appendChild(img);
            }
          } else {
            // If image is already inside a link, add the lightbox class to the link
            img.parentNode.classList.add('lightbox-image');
            
            // Store the original link href if it's not pointing to the image
            if (img.parentNode.href !== fullSizeImageSrc) {
              img.parentNode.setAttribute('data-original-href', img.parentNode.href);
              img.parentNode.href = fullSizeImageSrc;
            }
          }
        });
        
        // Initialize SimpleLightbox on the links we just created/modified
        var lightbox = new SimpleLightbox('a.lightbox-image', {
          captionPosition: 'bottom',
          captionsData: 'alt',
          captionDelay: 250,
          animationSpeed: 250,
          fadeSpeed: 200,
          scrollZoom: true,
          maxZoom: 3
        });
        
        console.log('SimpleLightbox initialized successfully with', contentImages.length, 'images');
      } catch (error) {
        console.error('Error initializing SimpleLightbox:', error);
      }
    }, 500);
  });
</script>
